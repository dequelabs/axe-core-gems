version: 2.1

defaults: &defaults
  docker:
    - image: circleci/ruby:2.5.3-node-browsers
      environment:
        FIREFOX_VERSION: 68.0.1
        GECKODRIVER_VERSION: 0.24.0
  working_directory: ~/axe-core-gems

commands:
  bootstrap:
    description: Install dependencies and bootstrap packages
    steps:
      - checkout
      - run: gem install bundler # setup bundler
      - run: bash ./.circleci/install-geckodriver.sh # install geckodriver
      - run: rake bootstrap # bootstrap packages

jobs:
  test-unit: 
    <<: *defaults
    steps:
      - bootstrap
      # unit test - API
      - run: rake test_unit\[axe-core-api\]
      # unit test - webdrivers
      - run: rake test_unit\[axe-core-selenium\]
      - run: rake test_unit\[axe-core-watir\]
      - run: rake test_unit\[axe-core-capybara\]
      # unit test - framework integrations
      - run: rake test_unit\[axe-core-cucumber\]
      - run: rake test_unit\[axe-core-rspec\]
  test-e2e:
    <<: *defaults
    steps:
      - bootstrap
      # e2e test - rspec
      - run: |
          cd packages/axe-core-rspec
          rake test_e2e
      # e2e test - cucumber
      - run: |
          cd packages/axe-core-cucumber
          rake test_e2e

workflows:
  version: 2
  build:
    jobs:
      - test-unit
      - test-e2e